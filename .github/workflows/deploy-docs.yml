name: Deploy Docs

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - repo_url: https://github.com/qian-o/Zenith.NET
            docs_folder: documents

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set project name
        id: project
        run: |
          $repoUrl = "${{ matrix.repo_url }}"
          $projectName = $repoUrl.Split('/')[-1]
          echo "name=$projectName" >> $env:GITHUB_OUTPUT

      - name: Clone source repository
        run: |
          git clone ${{ matrix.repo_url }} source-repo

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 10.0.x

      - name: Install Workload
        run: dotnet workload install maui

      - name: Install DocFX
        run: dotnet tool install -g docfx

      - name: Build documentation
        run: |
          cd source-repo/${{ matrix.docs_folder }}
          docfx docfx.json

      - name: Copy built documentation
        run: |
          # Remove existing folder if exists
          rm -rf "${{ steps.project.outputs.name }}"
          # Copy built documentation
          cp -r "source-repo/${{ matrix.docs_folder }}/_site" "${{ steps.project.outputs.name }}"
          echo "Documentation copied to ${{ steps.project.outputs.name }}/"

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add "${{ steps.project.outputs.name }}"
          git diff --staged --quiet || (git commit -m "Update ${{ steps.project.outputs.name }} documentation" && git push)
